name: Workflow C - Build ACK GKI android15-6.6-lts (arm64) - repo cache only

on:
  workflow_dispatch:
    inputs:
      manifest_branch:
        description: "kernel/manifest branch"
        required: true
        default: "common-android15-6.6-lts"
      bazel_target:
        description: "Kleaf dist target"
        required: true
        default: "//common:kernel_aarch64_dist"
      dist_dir:
        description: "Dist output directory (relative to gki/)"
        required: true
        default: "out/kernel_aarch64/dist"

jobs:
  build-gki-lts:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install host dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            git curl ca-certificates \
            python3 python3-venv python3-pip \
            bc bison flex build-essential \
            libssl-dev libelf-dev \
            rsync xz-utils zstd unzip jq file

          # Android "repo" tool
          sudo curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod +x /usr/local/bin/repo
          repo --version

      - name: Prepare GKI workspace
        run: |
          set -euo pipefail
          mkdir -p gki
          echo "GKI workspace root: $(pwd)/gki"

      # -------------------------------
      # Cache ONLY the repo sync state (.repo)
      # -------------------------------
      - name: Restore .repo cache (repo-sync cache only)
        id: cache-repo
        uses: actions/cache@v4
        with:
          path: gki/.repo
          key: repo-gki-${{ runner.os }}-${{ inputs.manifest_branch }}
          restore-keys: |
            repo-gki-${{ runner.os }}-${{ inputs.manifest_branch }}-
            repo-gki-${{ runner.os }}-

      - name: Debug - Cache status (.repo)
        run: |
          set -euo pipefail
          echo "cache-hit(.repo)=${{ steps.cache-repo.outputs.cache-hit }}"
          if [[ -d gki/.repo ]]; then
            echo "Sizes:"
            du -sh gki/.repo || true
            du -sh gki/.repo/manifests gki/.repo/manifests.git 2>/dev/null || true
            du -sh gki/.repo/projects gki/.repo/project-objects 2>/dev/null || true
          else
            echo "gki/.repo not present after restore (expected on first run)."
          fi

      # -------------------------------
      # repo init + sync (shallow to keep cache size manageable)
      # Note: always run repo init; it refreshes config even if .repo restored.
      # -------------------------------
      - name: repo init (lts, shallow)
        working-directory: gki
        run: |
          set -euo pipefail
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b "${{ inputs.manifest_branch }}" \
            --depth=1
          echo "repo init complete: branch=${{ inputs.manifest_branch }}"

      - name: repo sync (incremental, shallow)
        working-directory: gki
        run: |
          set -euo pipefail
          [[ -d .repo/manifests ]] || { echo "ERROR: .repo/manifests missing after repo init"; exit 1; }
          echo "Repo sync startingâ€¦ (cache-hit(.repo)=${{ steps.cache-repo.outputs.cache-hit }})"
          repo sync -c -j"$(nproc)" --no-tags --depth=1
          echo "Repo sync finished."

      # -------------------------------
      # Debug listing: approximately 3 directories deep from repo root (gki/)
      # Includes hidden dirs like .repo
      # -------------------------------
      - name: Debug - Directory summary (depth<=3) after sync
        working-directory: gki
        run: |
          set -euo pipefail
          echo "=== Directories (max depth 3) from gki/ ==="
          find . -maxdepth 3 -type d -print | sed -n '1,300p'
          echo "=== Files (max depth 3) from gki/ (first 300) ==="
          find . -maxdepth 3 -type f -print | sed -n '1,300p'

      - name: Guardrails - verify expected tree
        working-directory: gki
        run: |
          set -euo pipefail
          [[ -x tools/bazel ]] || { echo "ERROR: tools/bazel not found or not executable"; exit 1; }
          [[ -d common ]] || { echo "ERROR: expected 'common' project directory missing after repo sync"; exit 1; }
          echo "Guardrails OK."

      # -------------------------------
      # Build (NO Bazel cache is used)
      # -------------------------------
      - name: Build GKI dist (arm64) with Kleaf/Bazel
        working-directory: gki
        run: |
          set -euo pipefail
          echo "Running: ./tools/bazel run '${{ inputs.bazel_target }}' -- --dist_dir='${{ inputs.dist_dir }}'"
          ./tools/bazel run "${{ inputs.bazel_target }}" -- --dist_dir="${{ inputs.dist_dir }}"

      - name: Summarize dist outputs
        working-directory: gki
        run: |
          set -euo pipefail
          echo "Dist directory: ${{ inputs.dist_dir }}"
          ls -lah "${{ inputs.dist_dir }}" | sed -n '1,200p'
          if [[ -f "${{ inputs.dist_dir }}/boot.img" ]]; then
            echo "Found boot.img:"
            file "${{ inputs.dist_dir }}/boot.img" || true
          fi

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-android15-6.6-lts-arm64-dist
          path: gki/${{ inputs.dist_dir }}
          if-no-files-found: error