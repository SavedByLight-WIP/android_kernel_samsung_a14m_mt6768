name: Workflow B - Build ACK GKI android15-6.6-lts (arm64)

on:
  workflow_dispatch:

jobs:
  build-gki-lts:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      - name: Checkout this repo for workflow scripts
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up host dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl python3 python3-pip \
            bc bison flex build-essential \
            libssl-dev libelf-dev rsync xz-utils zstd unzip jq file
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo \
            -o /usr/local/bin/repo
          sudo chmod +x /usr/local/bin/repo
          repo --version

      - name: Prepare GKI workspace
        run: |
          mkdir -p gki
          echo "Workspace root: $(pwd)/gki"

      # -------------------------------
      # Compute stable cache key for .repo based on branch name
      - name: Compute .repo cache key
        id: cachekey
        run: |
          # Use branch name for simplicity (android15-6.6-lts)
          BRANCH="common-android15-6.6-lts"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      # -------------------------------
      # Cache Android repo tree
      - name: Restore .repo cache
        id: cache-repo
        uses: actions/cache@v4
        with:
          path: gki/.repo
          key: repo-gki-${{ steps.cachekey.outputs.branch }}
          restore-keys: |
            repo-gki-${{ steps.cachekey.outputs.branch }}-

      - name: Debug: Show .repo after restore
        if: steps.cache-repo.outputs.cache-hit == 'true'
        run: |
          echo "Cache hit for .repo ✔"
          du -sh gki/.repo || true
          ls -R gki/.repo/manifests/ -R | head -n 50 || true

      - name: Debug: Show cache-miss info
        if: steps.cache-repo.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss for .repo ❌"
          ls -lah gki || true

      # -------------------------------
      # repo init & sync (incremental if cached)
      - name: Initialize manifest (common-android15-6.6-lts)
        working-directory: gki
        run: |
          set -euo pipefail
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android15-6.6-lts
          echo "Initialized repo manifest for android15-6.6-lts"

      - name: Sync Android Common Kernel tree
        working-directory: gki
        run: |
          set -euo pipefail
          if [[ -d gki/.repo/manifests ]]; then
            echo "Updating existing workspace (from cache)…"
            repo sync -c -j"$(nproc)" --no-tags
          else
            echo "Full repo sync (cache empty)…"
            repo sync -c -j"$(nproc)" --force-sync --no-tags
          fi

      - name: Debug: List top-level synced dirs
        working-directory: gki
        run: |
          echo "Listing workspace root (depth 1-3):"
          find . -maxdepth 3 -print

      # -------------------------------
      # Cache Bazel outputs
      - name: Restore Bazel cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            gki/out
          key: bazel-gki-${{ runner.os }}-android15-6.6-lts

      # -------------------------------
      # Build GKI arm64 distribution
      - name: Build GKI (arm64) with Kleaf/Bazel
        working-directory: gki
        run: |
          set -euo pipefail
          echo "Starting Bazel build for //common:kernel_aarch64_dist"
          ./tools/bazel run //common:kernel_aarch64_dist \
            -- --dist_dir=out/kernel_aarch64/dist

      - name: Summarize dist outputs
        working-directory: gki
        run: |
          echo "Contents of output dist directory:"
          ls -lh out/kernel_aarch64/dist || true

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-android15-6.6-lts-dist
          path: gki/out/kernel_aarch64/dist
          if-no-files-found: error

      - name: Upload repo cache (debug)
        uses: actions/upload-artifact@v4
        with:
          name: gki-repo-cache-debug
          path: gki/.repo
